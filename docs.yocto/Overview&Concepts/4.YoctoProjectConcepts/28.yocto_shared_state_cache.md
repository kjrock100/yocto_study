# Yocto Project 공유 상태 캐시 (Shared State Cache)

**공유 상태 캐시(Shared State Cache, sstate-cache)**는 Yocto Project 빌드 시스템의 속도를 획기적으로 높여주는 핵심 메커니즘입니다. "한 번 빌드한 것은 다시 빌드하지 않는다"는 철학을 바탕으로 설계되었습니다.

## 1. 개요

BitBake는 빌드 작업을 수행할 때마다 해당 작업의 결과물을 캐시에 저장합니다. 이후 동일한 입력 조건으로 빌드가 요청되면, 실제 컴파일이나 패키징 작업을 다시 수행하는 대신 캐시된 결과물을 가져와 사용합니다.

*   **위치:** 기본적으로 `build/sstate-cache` 디렉토리에 저장되며, `SSTATE_DIR` 변수로 제어됩니다.
*   **효과:** `tmp/` 디렉토리를 삭제하고 다시 빌드하더라도, sstate-cache가 남아있다면 몇 시간 걸릴 빌드가 몇 분 안에 완료될 수 있습니다.

## 2. 작동 원리 (Architecture)

공유 상태 캐시의 작동 방식은 **체크섬(Checksum)**과 **셋씬(Setscene)** 개념에 의존합니다.

### 2.1 체크섬 (Signatures)
BitBake는 각 태스크(예: `do_compile`)를 실행하기 전에, 해당 태스크에 영향을 미치는 모든 입력 요소들을 모아 고유한 해시값(Signature)을 계산합니다.
*   **입력 요소:** 빌드 설정 변수, 태스크의 쉘 스크립트 코드, 의존성 있는 이전 태스크의 체크섬, 상속된 클래스 등.
*   **판단:** 만약 현재 계산된 체크섬과 일치하는 파일이 `sstate-cache`에 존재한다면, 입력이 변하지 않았으므로 결과도 동일할 것이라고 판단합니다.

### 2.2 셋씬 태스크 (Setscene Tasks)
캐시가 유효하다고 판단되면, BitBake는 원래의 태스크(예: `do_compile`)를 실행하지 않고, 대신 **셋씬 태스크(Setscene Task)**(예: `do_compile_setscene`)를 실행합니다.
*   이 태스크는 캐시된 타르볼(tarball)을 가져와서 적절한 위치에 압축을 해제하는 역할을 합니다.

## 3. 공유 및 협업

이 캐시는 이름 그대로 "공유"가 가능합니다. 팀 단위 개발이나 CI(Continuous Integration) 환경에서 매우 유용합니다.

### 3.1 로컬 공유
여러 빌드 디렉토리가 하나의 `sstate-cache` 디렉토리를 공유하도록 설정하여 디스크 공간과 빌드 시간을 절약할 수 있습니다.

### 3.2 네트워크 미러링 (SSTATE_MIRRORS)
빌드 서버나 다른 개발자가 생성한 캐시를 네트워크를 통해 읽어올 수 있습니다.

```bitbake
# local.conf 예시: 읽기 전용 미러 설정
SSTATE_MIRRORS ?= "file://.* http://sstate.yoctoproject.org/PATH/TO/SSTATE/PATH;downloadfilename=PATH"
```

## 4. 해시 동등성 (Hash Equivalence)

최신 Yocto Project에는 **해시 동등성** 기능이 도입되었습니다.
*   **문제:** 이전에는 공백 하나만 바뀌어도 체크섬이 바뀌어 불필요한 재빌드가 발생했습니다.
*   **해결:** 입력 체크섬이 다르더라도, 실제 생성된 출력물(바이너리 등)이 동일하다면 이를 "동등하다"고 표시하여 하위 의존성 태스크들의 재빌드를 방지합니다.

## 5. 요약

*   **속도:** 점진적 빌드(Incremental Build) 속도를 극대화합니다.
*   **검증:** 입력이 조금이라도 바뀌면 체크섬이 변경되므로, 항상 올바른 빌드 결과를 보장합니다.
*   **협업:** 이미 빌드된 아티팩트를 팀원 간에 공유하여 중복 작업을 제거합니다.

---
*참고: 빌드 문제 발생 시 `bitbake -c cleansstate <recipe>` 명령으로 특정 레시피의 캐시를 강제로 삭제하고 처음부터 다시 빌드할 수 있습니다.*
