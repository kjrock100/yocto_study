# Yocto Project Fakeroot와 Pseudo (Fakeroot and Pseudo)

Yocto Project 빌드 시스템은 호스트 시스템의 루트(root) 권한 없이도, 타겟 파일시스템에 대한 소유권(Ownership)과 권한(Permission)을 올바르게 설정하기 위해 **Fakeroot**와 **Pseudo**라는 메커니즘을 사용합니다.

## 1. 개요

임베디드 리눅스 이미지를 생성할 때, `/etc/shadow` 파일은 루트 소유여야 하고, `/bin/login`은 setuid 비트가 설정되어야 하는 등 특정 파일들은 루트 권한으로 생성되어야 합니다. 하지만 보안상의 이유로 Yocto 빌드 시스템(BitBake)은 일반 사용자 계정으로 실행됩니다.

**Pseudo**는 이러한 모순을 해결하기 위해, 일반 사용자가 마치 루트인 것처럼 파일 시스템 조작을 수행할 수 있게 해주는 도구입니다. **Fakeroot**는 이러한 환경을 실행하는 방식이나 명령어를 지칭합니다.

## 2. 필요성

만약 일반 사용자가 `chown root:root file` 명령을 실행하면 "Operation not permitted" 오류가 발생합니다.
하지만 최종 생성된 이미지(`rootfs`) 내부의 파일들은 반드시 올바른 UID/GID(User ID/Group ID)를 가져야 합니다.

Pseudo를 사용하면 호스트 파일시스템에는 일반 사용자 소유로 파일을 저장하지만, 별도의 데이터베이스에 "이 파일은 사실 루트 소유야"라고 기록해 둡니다. 나중에 이미지를 압축하거나 생성할 때 이 데이터베이스를 참조하여 올바른 권한을 가진 이미지를 만듭니다.

## 3. 작동 원리 (How Pseudo Works)

Pseudo는 `LD_PRELOAD` 환경 변수를 사용하여 리눅스 시스템 호출(System Calls)을 가로채는(Intercept) 방식으로 동작합니다.

1.  **가로채기:** `open()`, `chown()`, `chmod()`, `stat()` 등의 파일 시스템 관련 시스템 호출을 가로챕니다.
2.  **데이터베이스 기록:** 사용자가 `chown root file`을 실행하면, 실제 파일 시스템의 소유권은 변경하지 않고(실패하므로), Pseudo 내부 데이터베이스(SQLite)에 "file의 소유자는 root"라고 기록합니다.
3.  **속이기:** 이후 `ls -l`이나 `stat` 명령이 실행되면, 실제 파일 시스템의 정보 대신 데이터베이스에 기록된 가짜(Fake) 정보를 반환합니다.

## 4. BitBake에서의 사용

BitBake는 특정 태스크가 루트 권한을 필요로 할 때 자동으로 Pseudo 환경을 활성화합니다.

### 4.1 fakeroot 플래그
레시피에서 태스크를 정의할 때 `fakeroot` 키워드를 사용하면 해당 태스크는 Pseudo 환경에서 실행됩니다.

```python
fakeroot do_install() {
    # 여기서 실행되는 chown, install -o root 등의 명령은
    # 실제로는 실패하지 않고 Pseudo DB에 기록됩니다.
    install -d ${D}${sysconfdir}
    install -m 0644 ${WORKDIR}/myconfig ${D}${sysconfdir}/myconfig
    chown root:root ${D}${sysconfdir}/myconfig
}
```

### 4.2 주요 태스크
*   **`do_install`**: 파일을 목적지 디렉토리(`D`)에 설치할 때 올바른 권한을 설정하기 위해 사용됩니다.
*   **`do_rootfs`**: 패키지를 풀고 최종 이미지 파일시스템을 구성할 때, 각 패키지에 정의된 소유권 정보를 유지하기 위해 필수적으로 사용됩니다.

## 5. 요약

Pseudo는 Yocto Project가 **"일반 사용자 권한으로 루트 파일시스템을 완벽하게 구축"**할 수 있게 해주는 핵심 기술입니다. 이를 통해 개발자는 호스트 시스템의 보안을 위협하지 않으면서 안전하게 임베디드 리눅스를 빌드할 수 있습니다.
