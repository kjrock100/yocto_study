# Yocto Project 공유 상태 (Shared State)

**공유 상태(Shared State)**는 Yocto Project의 빌드 시스템인 BitBake가 빌드 효율성을 극대화하기 위해 사용하는 핵심 아키텍처입니다. 흔히 `sstate`라고 줄여서 부르며, 빌드 과정의 중간 결과물을 저장하고 재사용하는 메커니즘을 의미합니다.

## 1. 개요

일반적인 빌드 시스템(Make 등)은 파일의 타임스탬프를 보고 재빌드 여부를 결정하지만, Yocto Project는 **입력 데이터의 체크섬(Checksum)**을 기반으로 결정합니다. Shared State는 이러한 체크섬을 사용하여 "이 작업이 이전에 수행된 적이 있는지"를 판단하고, 그렇다면 실제 작업을 수행하는 대신 저장된 결과물을 복원합니다.

## 2. 핵심 철학

Shared State의 기본 철학은 **"입력이 동일하면 출력도 동일해야 한다"**는 결정론적(Deterministic) 빌드입니다.

*   **입력:** 소스 코드, 설정 변수(`CFLAGS` 등), 컴파일러 버전, 의존성 등 태스크 실행에 영향을 주는 모든 것.
*   **출력:** 컴파일된 바이너리, 설치된 파일, 생성된 패키지 등.

BitBake는 태스크를 실행하기 전에 모든 입력 요소를 모아 고유한 **서명(Signature)**을 생성합니다.

## 3. 작동 프로세스

빌드 과정에서 Shared State는 다음과 같이 작동합니다.

1.  **서명 계산:** BitBake가 태스크(예: `do_compile`)의 입력 서명을 계산합니다.
2.  **캐시 조회:** `SSTATE_DIR` 디렉토리에서 해당 서명과 일치하는 아티팩트(압축 파일)가 있는지 확인합니다.
3.  **분기 (Branching):**
    *   **캐시 히트 (Hit):** 유효한 아티팩트가 존재하면, 실제 태스크(`do_compile`)를 실행하지 않습니다. 대신 **Setscene Task**(`do_compile_setscene`)를 실행하여 아티팩트를 작업 디렉토리(`tmp/work/...`)에 압축 해제합니다.
    *   **캐시 미스 (Miss):** 유효한 아티팩트가 없으면, 실제 태스크를 실행합니다. 태스크가 성공적으로 완료되면, 그 결과물을 압축하여 SState Cache에 저장합니다.

## 4. 아티팩트의 구조

Shared State 아티팩트는 단순한 파일 복사본이 아닙니다.

*   **형식:** 주로 `.tar.zst` 또는 `.tar.gz` 형식의 압축 파일입니다.
*   **내용:** 태스크가 생성한 파일들(바이너리, 라이브러리 등)과 해당 파일들의 권한, 소유권 정보 등을 포함합니다.
*   **위치:** `SSTATE_DIR` 내부에 서명의 앞 두 글자를 딴 하위 디렉토리에 분산 저장됩니다 (예: `sstate-cache/a1/sstate:bash:do_compile:hash...tgz`).

## 5. 활용 및 이점

### 5.1 빌드 속도 가속
`tmp` 디렉토리를 삭제하고 처음부터 빌드하더라도(Clean Build), `sstate-cache`가 남아있다면 컴파일 과정을 건너뛰고 파일 복사만 수행하므로 빌드 시간이 획기적으로 단축됩니다.

### 5.2 협업 및 미러링
Shared State는 머신 간에 공유가 가능합니다.
*   **팀 공유:** 팀원들이 공용 NAS에 `SSTATE_DIR`을 설정하여 빌드 시간을 절약할 수 있습니다.
*   **SSTATE_MIRRORS:** CI 서버나 Yocto Project 공식 서버에서 미리 빌드된 캐시를 다운로드하여 사용할 수 있습니다.

## 6. 관리 명령어

특정 레시피의 Shared State가 꼬이거나 강제로 다시 빌드하고 싶을 때 다음 명령어를 사용합니다.

```bash
# bash 레시피의 sstate 캐시와 작업 디렉토리를 모두 삭제
bitbake -c cleansstate bash
```
