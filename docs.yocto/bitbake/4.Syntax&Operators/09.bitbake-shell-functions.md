# 셸 함수 (Shell Functions)

BitBake 레시피에서 태스크(Task)의 대부분은 셸 함수로 구현됩니다. 이들은 `/bin/sh` (대부분의 배포판에서 `bash`로 심볼릭 링크됨) 셸 스크립트로 실행됩니다.

## 4.5.1 셸 함수 정의 (Defining Shell Functions)

레시피(`.bb`)나 클래스(`.bbclass`) 파일 내에서 표준 셸 스크립트 문법을 사용하여 정의합니다.

```bitbake
my_shell_function() {
    echo "Hello from a shell function"
    echo "The value of FOO is ${FOO}"
}
```

## 4.5.1.1 실행 동작 (Execution Behavior)

*   **스크립트 생성**: BitBake는 함수 본문을 가져와 필요한 환경 변수 설정과 함께 임시 스크립트 파일(`run.do_taskname.pid`)을 생성하여 실행합니다.
*   **에러 처리 (`set -e`)**: 기본적으로 `set -e` 옵션이 활성화된 상태로 실행됩니다. 따라서 함수 내의 명령어가 0이 아닌 종료 코드를 반환하면, 실행이 즉시 중단되고 해당 태스크는 실패(Failure)로 처리됩니다. 실패를 허용해야 하는 명령어가 있다면 `|| true`를 뒤에 붙여야 합니다.

    ```bitbake
    do_example() {
        # 실패하면 태스크 중단
        cp foo bar
        
        # 실패해도 계속 진행
        rm non_existent_file || true
    }
    ```

## 4.5.1.2 로깅 및 메시지 출력 (Logging)

BitBake는 셸 함수 내에서 사용할 수 있는 로깅 유틸리티 함수들을 제공합니다.

*   `bbplain`: 일반 텍스트 출력
*   `bbnote`: 정보성 메시지 (Note)
*   `bbwarn`: 경고 메시지 (Warning)
*   `bberror`: 에러 메시지 (Error) - 빌드를 중단시키지는 않음
*   `bbfatal`: 치명적 에러 (Fatal Error) - 빌드를 즉시 중단시킴
*   `bbdebug <level> "msg"`: 디버그 메시지

```bitbake
do_compile() {
    bbnote "Starting compilation..."
    if [ ! -f Makefile ]; then
        bbfatal "Makefile not found!"
    fi
    make
}
```

## 4.5.1.3 변수 사용 (Using Variables)

BitBake 변수는 셸 환경 변수로 export 되어 함수 내에서 사용할 수 있습니다. 단, 변수가 export 되도록 설정되어 있어야 합니다. (대부분의 표준 변수들은 export 됩니다.)

## 4.5.1.4 함수 수정 및 확장 (Modifying Functions)

기존에 정의된 셸 함수를 수정하거나 확장할 수 있습니다.

*   **오버라이드 스타일 (`:append`, `:prepend`)**: 기존 함수 본문의 앞이나 뒤에 셸 코드를 추가합니다.

    ```bitbake
    do_install:append() {
        echo "Post-install actions"
        rm ${D}${bindir}/unwanted_tool
    }
    ```

## 4.5.1.5 Fakeroot 함수

`fakeroot` 키워드가 붙은 함수는 가상 루트 환경(Pseudo)에서 실행됩니다. 파일의 소유권(UID/GID)을 변경하거나 특수 권한을 설정해야 하는 `do_install`, `do_package` 등의 태스크에서 필수적입니다.

```bitbake
fakeroot do_install() {
    install -d ${D}/etc
    install -m 0644 ${S}/config ${D}/etc/
    chown root:root ${D}/etc/config
}
```
