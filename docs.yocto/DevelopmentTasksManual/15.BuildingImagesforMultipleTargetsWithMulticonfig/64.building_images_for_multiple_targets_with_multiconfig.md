# Yocto Project: Multiconfig를 사용한 다중 타겟 이미지 빌드 (Building Images for Multiple Targets With Multiconfig)

이 문서는 Yocto Project Development Tasks Manual의 15장을 기반으로, Multiconfig 기능을 사용하여 한 번의 빌드 명령으로 서로 다른 구성을 가진 여러 이미지를 빌드하고 의존성을 관리하는 방법을 설명합니다.

## 15.1 다중 구성 빌드 설정 및 실행 (Setting Up and Running a Multiple Configuration Build)

Multiconfig를 사용하면 단일 BitBake 세션에서 여러 타겟(예: 메인 프로세서용 Linux와 보조 프로세서용 펌웨어)을 동시에 빌드할 수 있습니다.

1. **BBMULTICONFIG 설정**:
    `conf/local.conf` 파일에 `BBMULTICONFIG` 변수를 정의하여 사용할 구성의 이름을 지정합니다.

    ```bitbake
    BBMULTICONFIG = "configA configB"
    ```

2. **구성 파일 생성**:
    각 구성 이름에 해당하는 `.conf` 파일을 `conf/multiconfig/` 디렉토리에 생성합니다.
    * `conf/multiconfig/configA.conf`
    * `conf/multiconfig/configB.conf`
    각 파일에는 해당 타겟에 필요한 `MACHINE`, `TMPDIR`, `DISTRO` 등의 변수를 설정합니다.

3. **빌드 실행**:
    `mc:` 접두사를 사용하여 특정 구성의 타겟을 빌드합니다.

    ```bash
    bitbake mc:configA:core-image-minimal
    bitbake mc:configB:core-image-sato
    ```

## 15.2 다중 구성 빌드 의존성 활성화 (Enabling Multiple Configuration Build Dependencies)

서로 다른 구성 간에 의존성이 있는 경우(예: configB에서 빌드한 펌웨어를 configA의 이미지에 포함), `mcdepends` 플래그를 사용하여 태스크 간 의존성을 정의할 수 있습니다.

* **구문**:

    ```bitbake
    do_task[mcdepends] = "mc:<from_config>:<to_config>:<recipe_name>:<task_name>"
    ```

  * `from_config`: 현재 실행 중인 구성 (또는 `default`).
  * `to_config`: 의존하는 대상 구성.
  * `recipe_name`: 의존하는 레시피 이름.
  * `task_name`: 의존하는 태스크 이름 (예: `do_deploy`).

* **예시**:

    ```bitbake
    do_image_complete[mcdepends] = "mc:default:configB:my-firmware:do_deploy"
    ```

## 15.3 권장 모범 사례 (Suggested Best Practices)

* **TMPDIR 분리**: 각 구성마다 별도의 `TMPDIR`을 사용하여 빌드 아티팩트 충돌을 방지해야 합니다.

    ```bitbake
    # conf/multiconfig/configA.conf
    TMPDIR = "${TOPDIR}/tmp-configA"
    ```

* **공유 상태 캐시**: `SSTATE_DIR`과 `DL_DIR`은 공유하여 빌드 시간을 단축할 수 있습니다.

## 15.4 일반적인 사용 사례: Linux 빌드와 함께 베어메탈 펌웨어 빌드 (Common Use Case: Building Baremetal Firmware Alongside a Linux Build)

가장 흔한 시나리오는 메인 CPU에서 실행될 Linux 시스템과 보조 MCU에서 실행될 펌웨어를 함께 빌드하여 최종 이미지에 통합하는 것입니다.

1. **펌웨어용 Multiconfig 추가**: `conf/multiconfig/firmware.conf`를 생성하고 베어메탈용 `MACHINE`과 `TMPDIR`을 설정합니다.
2. **펌웨어 빌드**: 펌웨어 레시피를 작성합니다.
3. **Linux 이미지에서 사용**: Linux 이미지 레시피에서 `mcdepends`를 사용하여 펌웨어의 `do_deploy` 태스크 완료를 기다리고, 배포된 펌웨어 파일을 가져와 루트 파일시스템에 설치합니다.

---
참고: Multiconfig는 강력하지만 설정이 복잡할 수 있으므로, 디렉토리 구조와 변수 스코프를 명확히 이해하고 사용하는 것이 중요합니다.
