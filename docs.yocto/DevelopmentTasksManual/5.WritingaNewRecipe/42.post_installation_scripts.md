# Yocto Project: 설치 후 스크립트 (Post-Installation Scripts)

이 문서는 Yocto Project Development Tasks Manual의 5.19절을 기반으로, 패키지 설치 후 실행되는 스크립트(Post-installation scripts)를 작성하고 관리하는 방법에 대해 설명합니다.

## 5.19 개요 (Overview)

설치 후 스크립트는 패키지가 설치된 직후에 실행되는 쉘 스크립트입니다. 주로 설정 파일 수정, 서비스 재시작, 사용자 생성 등의 작업에 사용됩니다. Yocto Project에서는 이러한 스크립트가 **빌드 호스트에서 이미지를 생성할 때(Offline)** 실행될 수도 있고, **타겟 장치에서 패키지가 설치될 때(Online)** 실행될 수도 있다는 점을 이해하는 것이 중요합니다.

## 5.19.1 스크립트 정의 (Defining the Script)

레시피 내에서 `pkg_postinst` 함수를 정의하여 스크립트를 작성합니다. 패키지별로 적용되므로 패키지 이름 오버라이드(예: `:${PN}`)를 사용해야 합니다.

* **구문**:

    ```bitbake
    pkg_postinst:${PN}() {
        #!/bin/sh
        # 스크립트 내용
    }
    ```

## 5.19.2 실행 시점과 ${D} 변수 (Execution Time and ${D})

스크립트는 두 가지 시점에 실행될 수 있습니다.

1. **이미지 생성 시 (Offline)**: BitBake가 루트 파일시스템(rootfs)을 만들 때 호스트 머신에서 실행됩니다.
2. **타겟 실행 시 (Online)**: 장치가 부팅된 후 패키지 관리자(RPM, IPK, DEB)를 통해 패키지가 설치될 때, 또는 첫 부팅 시 지연 실행될 때 실행됩니다.

이 두 상황을 구분하기 위해 `${D}` 환경 변수를 확인합니다.

* **Offline**: `${D}`가 설정되어 있으며, 이는 호스트 내의 임시 루트 파일시스템 경로를 가리킵니다.
* **Online**: `${D}`가 비어 있거나 설정되지 않았습니다.

## 5.19.3 실행 지연 (Deferring Execution)

스크립트가 하드웨어에 접근해야 하거나 타겟에서만 실행되어야 하는 경우, 이미지 생성 단계에서는 실행을 실패시키고 타겟에서의 첫 부팅 시점으로 실행을 미룰 수 있습니다.
스크립트가 `exit 1`로 종료되면, 패키지 관리자는 이를 실패로 간주하지 않고 **첫 부팅 시 다시 실행하도록 예약**합니다.

* **패턴**:

    ```bitbake
    pkg_postinst:${PN}() {
        if [ -n "$D" ]; then
            # 이미지 생성 시점 (Offline)
            # 타겟에서 실행되도록 지연시킴
            exit 1
        fi

        # 타겟 실행 시점 (Online)
        # 실제 작업 수행
        echo "Running on target"
    }
    ```

## 5.19.4 pkg_postinst_ontarget 사용 (Using pkg_postinst_ontarget)

항상 타겟에서만 실행되어야 하는 스크립트라면, `pkg_postinst` 대신 `pkg_postinst_ontarget`을 사용하면 편리합니다. 이 함수는 내부적으로 `${D}` 체크와 `exit 1` 로직을 포함하고 있습니다.

* **예시**:

    ```bitbake
    pkg_postinst_ontarget:${PN}() {
        # 이 내용은 항상 타겟에서만 실행됩니다.
        systemctl restart myservice
    }
    ```

## 5.19.5 주의사항 (Best Practices)

* **크로스 컴파일 호환성**: Offline 실행 시 호스트의 바이너리가 아닌 타겟용 바이너리를 실행하려고 하면 실패합니다. 따라서 Offline 실행 경로에서는 파일 조작(cp, sed 등)만 수행해야 합니다.
* **절대 경로**: Offline 실행 시 모든 파일 경로는 `${D}`를 접두어로 사용해야 합니다. (예: `${D}/etc/config`)

---
참고: `pkg_preinst` (설치 전), `pkg_prerm` (삭제 전), `pkg_postrm` (삭제 후) 스크립트도 유사한 방식으로 정의할 수 있습니다.
