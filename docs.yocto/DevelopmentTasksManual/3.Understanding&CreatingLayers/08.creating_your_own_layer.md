# 자신만의 레이어 생성 (Creating Your Own Layer)

Yocto Project에서 시스템을 커스터마이징하거나 새로운 기능을 추가할 때, 기존 소스를 직접 수정하는 대신 **자신만의 레이어**를 생성하여 작업하는 것이 표준 절차입니다. 이 문서는 레이어를 생성하는 이유와 구체적인 방법을 설명합니다.

## 1. 레이어를 생성해야 하는 이유
- **격리 (Isolation)**: Poky나 다른 커뮤니티 레이어의 코드를 수정하지 않고 변경 사항을 별도로 관리할 수 있습니다.
- **이식성 (Portability)**: 특정 하드웨어나 프로젝트에 종속된 설정을 레이어 단위로 묶어 다른 프로젝트에서도 재사용할 수 있습니다.
- **유지보수 (Maintenance)**: Yocto Project 버전이 업그레이드되더라도 내 레이어만 관리하면 되므로 업그레이드가 용이합니다.

## 2. bitbake-layers 스크립트 사용
레이어를 수동으로 생성할 수도 있지만, `bitbake-layers` 도구를 사용하면 필수 파일과 디렉토리 구조를 자동으로 생성해 주므로 훨씬 간편합니다.

### 2.1. 레이어 생성 명령어
빌드 환경이 초기화된 터미널에서 다음 명령어를 실행합니다.

```bash
bitbake-layers create-layer meta-mylayer
```

여기서 `meta-mylayer`는 생성할 레이어의 이름입니다. 관례적으로 레이어 이름은 `meta-` 접두어로 시작합니다.

### 2.2. 생성되는 파일 구조
명령어를 실행하면 다음과 같은 구조가 생성됩니다.

```text
meta-mylayer/
├── conf/
│   └── layer.conf
├── COPYING.MIT
├── recipes-example/
│   └── example/
│       └── example_0.1.bb
└── README
```

- **conf/layer.conf**: 레이어의 핵심 설정 파일입니다. BitBake가 레시피를 찾는 경로(`BBFILES`)와 레이어 우선순위(`BBFILE_PRIORITY`) 등을 정의합니다.
- **recipes-example/**: 예제 레시피가 포함되어 있습니다. 실제 개발 시에는 `recipes-core`, `recipes-kernel` 등으로 필요한 디렉토리를 만들어 사용합니다.

## 3. layer.conf 파일 이해하기
자동 생성된 `conf/layer.conf` 파일은 다음과 같은 주요 변수들을 포함합니다.

```bash
# We have a conf and classes directory, add to BBPATH
BBPATH .= ":${LAYERDIR}"

# We have recipes-* directories, add to BBFILES
BBFILES += "${LAYERDIR}/recipes-*/*/*.bb \
            ${LAYERDIR}/recipes-*/*/*.bbappend"

BBFILE_COLLECTIONS += "meta-mylayer"
BBFILE_PATTERN_meta-mylayer = "^${LAYERDIR}/"
BBFILE_PRIORITY_meta-mylayer = "6"

LAYERDEPENDS_meta-mylayer = "core"
LAYERSERIES_COMPAT_meta-mylayer = "scarthgap"
```

- **BBPATH**: BitBake가 `.conf` 및 `.bbclass` 파일을 검색하는 경로에 현재 레이어 디렉토리를 추가합니다.
- **BBFILES**: 이 레이어 내의 레시피(`.bb`)와 어펜드 파일(`.bbappend`)의 위치를 정의합니다.
- **BBFILE_PRIORITY**: 레이어의 우선순위를 설정합니다. 숫자가 클수록 우선순위가 높습니다.
- **LAYERSERIES_COMPAT**: 이 레이어가 호환되는 Yocto Project 릴리스 버전(예: `scarthgap`, `kirkstone`)을 명시합니다. 이 값이 맞지 않으면 빌드 시 에러가 발생합니다.

## 4. 레이어 활성화 (Adding the Layer)
레이어를 생성한 후에는 빌드 시스템이 이를 인식하도록 `bblayers.conf` 파일에 추가해야 합니다.

```bash
bitbake-layers add-layer ../meta-mylayer
```

이 명령을 실행하면 `build/conf/bblayers.conf` 파일의 `BBLAYERS` 변수에 해당 레이어의 경로가 자동으로 추가됩니다.
