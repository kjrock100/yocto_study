# 다른 레이어의 메타데이터 확장 (Appending Other Layers Metadata With Your Layer)

Yocto Project에서 기존 레이어(예: Poky, Meta-OE)의 레시피를 수정해야 할 때, 원본 파일을 직접 수정하는 것은 유지보수 측면에서 권장되지 않습니다. 대신 **.bbappend** 파일을 사용하여 자신의 레이어에서 메타데이터를 안전하게 추가하거나 변경해야 합니다.

## 1. .bbappend 파일 개요

`.bbappend` 파일은 원본 레시피(`.bb`)와 짝을 이루며, BitBake가 빌드 시 원본 레시피를 파싱한 후 이어서 파싱하여 설정을 덮어쓰거나 추가합니다.

- **파일명 규칙**: 원본 레시피 이름과 일치해야 합니다.
  - 예: `busybox_1.36.bb` -> `busybox_1.36.bbappend`
  - 권장: 버전 업그레이드에 유연하게 대응하기 위해 `%` 와일드카드를 사용합니다 (`busybox_%.bbappend`).
- **위치**: 자신의 레이어 내에서 원본 레시피와 유사한 디렉토리 구조에 위치시킵니다.

## 2. 파일 오버레이 (Overlaying a File Using Your Layer)

기존 레시피가 사용하는 설정 파일이나 소스 파일을 내 레이어에 있는 파일로 교체하고 싶을 때 사용합니다. 이를 위해 `FILESEXTRAPATHS` 변수를 사용하여 검색 경로의 우선순위를 높입니다.

### 2.1. FILESEXTRAPATHS 설정

```bash
FILESEXTRAPATHS:prepend := "${THISDIR}/${PN}:"
```

- **prepend**: 기존 경로보다 앞에 추가하여 내 파일을 먼저 찾도록 합니다.
- **:=**: 변수를 즉시 확장하여 현재 디렉토리 위치를 정확히 잡습니다.
- **${THISDIR}/${PN}**: 관례적으로 레시피 이름과 같은 하위 디렉토리에 파일을 둡니다.

### 2.2. 예시: defconfig 교체

커널이나 BusyBox의 기본 설정을 변경하려면:

1. 내 레이어에 `recipes-core/busybox/busybox/defconfig` 파일을 생성합니다.
2. `recipes-core/busybox/busybox_%.bbappend` 파일을 생성하고 위 `FILESEXTRAPATHS` 코드를 추가합니다.

## 3. 추가 파일 설치 (Installing Additional Files Using Your Layer)

기존 레시피에 없는 새로운 파일(스크립트, 설정 파일 등)을 추가하여 이미지에 포함시키고 싶을 때 사용합니다.

### 3.1. 절차

1. **SRC_URI 추가**: 새 파일을 소스 목록에 추가합니다.
2. **do_install:append 작성**: 빌드 과정의 설치 단계 후에 실행될 쉘 함수를 작성하여 파일을 대상 디렉토리(`${D}`)로 복사합니다.

### 3.2. 예시: 커스텀 스크립트 설치

```bash
FILESEXTRAPATHS:prepend := "${THISDIR}/${PN}:"

SRC_URI += "file://myscript.sh"

do_install:append() {
    install -d ${D}${bindir}
    install -m 0755 ${WORKDIR}/myscript.sh ${D}${bindir}/myscript.sh
}
```

## 4. 변수 및 함수 수정

파일 조작 외에도 레시피의 다양한 변수를 수정할 수 있습니다.

- **의존성 추가**: `DEPENDS += " libnew"`
- **패키지 설정**: `EXTRA_OECONF += "--enable-my-feature"`
- **함수 변경**: 기존 함수를 덮어쓰거나, `_append`, `_prepend`를 사용하여 기능을 확장할 수 있습니다.

## 5. 주의사항

- **레이어 우선순위**: 여러 레이어가 동일한 `.bbappend`를 제공할 경우, `BBFILE_PRIORITY`가 높은 레이어의 설정이 적용되거나, 적용 순서에 따라 결과가 달라질 수 있습니다.
- **경로 확인**: `FILESEXTRAPATHS` 설정 시 콜론(`:`)을 빠뜨리지 않도록 주의해야 합니다.
