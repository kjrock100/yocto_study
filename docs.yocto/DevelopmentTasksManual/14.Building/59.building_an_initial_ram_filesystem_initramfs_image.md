# Yocto Project: 초기 RAM 파일시스템 (Initramfs) 이미지 빌드 (Building an Initial RAM Filesystem (Initramfs) Image)

이 문서는 Yocto Project Development Tasks Manual의 14.3절을 기반으로, 부팅 초기 단계에서 사용되는 Initramfs 이미지를 빌드하고 커널과 통합하는 방법을 설명합니다.

## 14.3 개요 (Overview)

Initramfs(Initial RAM Filesystem)는 커널이 실제 루트 파일시스템을 마운트하기 전에 메모리에 로드하여 실행하는 작은 파일시스템입니다. 주로 암호화된 디스크 마운트, 네트워크 부팅, 또는 복잡한 스토리지 설정(LVM, RAID) 초기화와 같이 커널이 직접 처리하기 어려운 작업을 수행하는 데 사용됩니다.

## 14.3.1 Initramfs 이미지 지정 (Specifying the Initramfs Image)

Initramfs를 사용하려면 먼저 Initramfs용으로 빌드할 이미지 레시피를 지정해야 합니다. `core-image-minimal-initramfs`는 Yocto Project에서 제공하는 기본 레시피입니다.

* **설정 (`local.conf` 또는 머신 설정)**:

    ```bitbake
    INITRAMFS_IMAGE = "core-image-minimal-initramfs"
    INITRAMFS_IMAGE_BUNDLE = "1"
    ```

  * `INITRAMFS_IMAGE`: Initramfs로 사용할 이미지 레시피의 이름입니다.
  * `INITRAMFS_IMAGE_BUNDLE`: "1"로 설정하면 커널 이미지와 Initramfs를 하나의 바이너리로 결합(Bundle)합니다.

## 14.3.2 initramfs-framework를 사용한 커스터마이징 (Customizing an Initramfs using initramfs-framework)

Yocto Project는 Initramfs 내부의 초기화 스크립트를 모듈식으로 관리할 수 있는 `initramfs-framework`를 제공합니다. 이를 사용하면 쉘 스크립트를 직접 작성하는 대신 필요한 모듈을 설치하여 기능을 구성할 수 있습니다.

* **주요 패키지**:
  * `initramfs-framework-base`: 기본 프레임워크 및 `/init` 스크립트.
  * `initramfs-module-udev`: `udev` 데몬 실행.
  * `initramfs-module-e2fs`: ext2/3/4 파일시스템 지원.
  * `initramfs-module-debug`: 부팅 중 쉘 접근 등 디버깅 기능 제공.

* **레시피 예시**:

    ```bitbake
    # my-initramfs.bb
    IMAGE_INSTALL = "initramfs-framework-base initramfs-module-udev initramfs-module-e2fs busybox"
    ```

## 14.3.3 별도의 Multiconfig에서 Initramfs 번들링 (Bundling an Initramfs Image From a Separate Multiconfig)

때로는 커널과 Initramfs가 서로 다른 아키텍처나 설정을 가져야 할 때가 있습니다 (예: 64비트 커널에 32비트 Initramfs 사용, 또는 Initramfs 크기를 줄이기 위해 다른 C 라이브러리 사용). 이때는 Multiconfig를 사용하여 Initramfs를 별도로 빌드하고 커널에 번들링할 수 있습니다.

1. **Multiconfig 설정**:
    `conf/multiconfig/initramfs.conf`와 같은 설정 파일을 만들고 필요한 설정(예: `TUNE_ARCH`)을 정의합니다.

2. **변수 설정**:
    커널을 빌드하는 메인 설정에서 `INITRAMFS_MULTICONFIG` 변수를 사용합니다.

    ```bitbake
    INITRAMFS_MULTICONFIG = "initramfs-config:core-image-minimal-initramfs"
    ```

    * 형식: `conf-name:recipe-name`

## 14.3.4 주의사항 (Notes)

* **커널 설정**: 커널 구성(`defconfig`)에서 `CONFIG_BLK_DEV_INITRD=y`가 설정되어 있어야 합니다.
* **이미지 크기**: Initramfs는 메모리에 로드되므로 크기를 최소화하는 것이 중요합니다. 불필요한 패키지를 제거하고 BusyBox 등을 활용해야 합니다.

---
참고: `INITRAMFS_IMAGE_BUNDLE`을 사용하면 커널 업데이트 시 Initramfs도 함께 업데이트되므로 관리가 용이하지만, 커널 이미지 크기가 커질 수 있습니다.
