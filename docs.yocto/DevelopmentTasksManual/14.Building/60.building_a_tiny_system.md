# Yocto Project: 초소형 시스템 빌드 (Building a Tiny System)

이 문서는 Yocto Project Development Tasks Manual의 14.4절을 기반으로, 메모리와 저장 공간이 매우 제한된 장치를 위해 시스템 크기를 최소화하는 전략과 방법을 설명합니다.

## 14.4.1 개요 (Tiny System Overview)

임베디드 시스템 중에는 수 MB의 저장 공간과 RAM만으로 동작해야 하는 경우가 있습니다. Yocto Project는 이러한 요구사항을 충족시키기 위해 `poky-tiny`라는 참조 배포판 구성을 제공하며, 이를 통해 필수적인 기능만 포함된 초소형 이미지를 빌드할 수 있습니다.

## 14.4.2 목표 및 원칙 (Goals and Guiding Principles)

초소형 시스템 구축의 핵심 원칙은 "필요하지 않은 것은 포함하지 않는다"입니다.

* **목표**: 부팅 시간 단축, 저장 공간 절약, 메모리 사용량 최소화.
* **접근법**: 기본 기능을 제공하는 경량화된 대안(예: glibc 대신 musl, systemd 대신 busybox-init)을 사용합니다.

## 14.4.3 이미지 크기 기여 요소 이해 (Understand What Contributes to Your Image Size)

이미지 크기를 줄이려면 무엇이 공간을 차지하는지 파악해야 합니다.

1. **커널 (Kernel)**: 드라이버, 파일시스템 지원, 네트워크 스택 등.
2. **루트 파일시스템 (Root Filesystem)**: 쉘, 유틸리티, 라이브러리(libc), 설정 파일.
3. **패키지 관리 (Package Management)**: 패키지 데이터베이스 및 관리 도구(opkg, rpm 등).

## 14.4.4 루트 파일시스템 줄이기 (Trim the Root Filesystem)

* **배포판 정책 변경**: `local.conf`에서 `DISTRO`를 `poky-tiny`로 설정합니다.

    ```bitbake
    DISTRO = "poky-tiny"
    ```

    이 설정은 `DISTRO_FEATURES`를 최소화하여 그래픽(X11, Wayland), 대형 라이브러리 등을 비활성화합니다.
* **C 라이브러리 변경**: `glibc` 대신 경량화된 `musl`을 사용합니다 (`TCLIBC = "musl"`).
* **초기화 시스템**: 무거운 `systemd`나 `SysVinit` 대신 `busybox-init`이나 `mdev`를 사용합니다.

## 14.4.5 커널 줄이기 (Trim the Kernel)

커널은 시스템 크기의 큰 비중을 차지합니다.

* **구성 최적화**: `defconfig`를 사용하여 불필요한 드라이버, 파일시스템, 디버깅 기능(printk, symbol table)을 비활성화합니다.
* **모듈 최소화**: 가능한 한 기능을 커널에 내장(built-in)하고, 모듈 로더 기능을 제거하거나 꼭 필요한 모듈만 남깁니다.
* **yocto-kernel-cache**: `ktypes/tiny`와 같은 커널 메타데이터를 활용합니다.

## 14.4.6 패키지 관리 요구사항 제거 (Remove Package Management Requirements)

런타임에 패키지를 설치하거나 업데이트할 계획이 없다면, 패키지 관리 시스템을 이미지에서 제거하여 상당한 공간을 절약할 수 있습니다.

* **설정**:

    ```bitbake
    IMAGE_FEATURES:remove = "package-management"
    ```

    이렇게 하면 `opkg`, `rpm` 등의 바이너리와 `/var/lib/opkg` 같은 데이터베이스가 이미지에 포함되지 않습니다.

## 14.4.7 크기를 줄이는 다른 방법 (Look for Other Ways to Minimize Size)

* **로케일 제거**: 다국어 지원이 필요 없다면 `IMAGE_LINGUAS`를 비웁니다.

    ```bitbake
    IMAGE_LINGUAS = ""
    ```

* **추천 패키지 제외**: `NO_RECOMMENDATIONS = "1"`을 설정하여 필수 의존성(`RDEPENDS`)만 설치하고 추천 패키지(`RRECOMMENDS`)는 무시합니다.
* **정적 링크**: 공유 라이브러리 오버헤드를 피하기 위해 애플리케이션을 정적으로 링크하는 것을 고려할 수 있습니다.
* **컴파일러 최적화**: 크기 최적화 플래그(`-Os`)를 사용합니다.

## 14.4.8 프로세스 반복 (Iterate on the Process)

시스템 축소는 반복적인 과정입니다.

1. 이미지를 빌드합니다.
2. `buildhistory`나 `wic ls` 등을 사용하여 이미지 내용을 분석합니다.
3. 가장 큰 구성 요소를 찾아 줄이거나 제거합니다.
4. 시스템이 여전히 부팅되고 필요한 기능을 수행하는지 테스트합니다.
5. 목표 크기에 도달할 때까지 반복합니다.

---
참고: `poky-tiny`는 매우 제한적인 환경을 제공하므로, 필요한 기능(예: WiFi, 특정 하드웨어 지원)을 추가하려면 `local.conf`나 레시피에서 명시적으로 활성화해야 할 수 있습니다.
