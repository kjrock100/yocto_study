# 17 호스트 리소스 사용 제한 (Limiting the Host Resources Usage)

Yocto Project 빌드 시스템(BitBake)은 기본적으로 호스트 시스템의 모든 가용 CPU 코어를 활용하여 빌드 시간을 최소화하도록 설계되어 있습니다. 하지만 공유 서버를 사용하거나, 빌드 중에 다른 작업을 병행해야 하거나, 또는 메모리 부족(OOM) 현상을 방지해야 하는 경우에는 호스트 리소스 사용을 제한할 필요가 있습니다.

리소스 사용을 제어하는 가장 일반적인 방법은 `conf/local.conf` 파일에서 병렬 처리와 관련된 변수를 조정하는 것입니다.

## 17.1 병렬 처리 변수 설정

주로 사용되는 두 가지 변수는 `BB_NUMBER_THREADS`와 `PARALLEL_MAKE`입니다.

### BB_NUMBER_THREADS

이 변수는 BitBake가 동시에 실행할 수 있는 태스크(Task)의 최대 개수를 지정합니다. 태스크에는 레시피 파싱, 다운로드, 구성(configure), 컴파일, 패키징 등이 포함됩니다.

* **기본 동작:** 설정하지 않을 경우, BitBake는 호스트의 CPU 코어 수를 감지하여 그에 맞는 값을 자동으로 설정합니다.
* **설정 방법:** `conf/local.conf` 파일에 다음과 같이 설정합니다.

    ```bash
    BB_NUMBER_THREADS = "4"
    ```

### PARALLEL_MAKE

이 변수는 컴파일러(주로 Make)가 소스 코드를 컴파일할 때 사용할 병렬 스레드(프로세스)의 수를 지정합니다. 이는 `make` 명령의 `-j` 옵션에 전달됩니다.

* **기본 동작:** 설정하지 않을 경우, 호스트의 CPU 코어 수에 맞춰 설정됩니다.
* **설정 방법:** `conf/local.conf` 파일에 다음과 같이 설정합니다.

    ```bash
    PARALLEL_MAKE = "-j 4"
    ```

## 17.2 설정 예시

예를 들어, 8코어 CPU를 가진 호스트 머신에서 절반의 리소스만 사용하여 빌드를 수행하고 싶다면 `build/conf/local.conf` 파일에 다음과 같이 추가합니다:

```bash
BB_NUMBER_THREADS = "4"
PARALLEL_MAKE = "-j 4"
```

이렇게 설정하면 BitBake는 최대 4개의 태스크를 동시에 실행하며, 각 태스크 내의 컴파일 작업도 최대 4개의 스레드를 사용하게 됩니다.

## 17.3 메모리 사용량 고려 사항

CPU 코어가 매우 많은 시스템(예: 64코어 이상)에서는 `BB_NUMBER_THREADS`와 `PARALLEL_MAKE`를 최대로 설정할 경우, 링커(Linker)와 같이 메모리를 많이 사용하는 프로세스가 동시에 다수 실행되어 시스템 메모리가 고갈될 수 있습니다.

이러한 경우, CPU 사용률보다는 메모리 안정성을 위해 `BB_NUMBER_THREADS` 값을 낮추어 동시에 실행되는 무거운 태스크의 수를 줄이는 것이 좋습니다.

> **참고:** 일부 레시피는 병렬 빌드를 지원하지 않을 수 있으며, 이 경우 해당 레시피 내에서 자체적으로 병렬 빌드 옵션을 비활성화합니다. 사용자가 `local.conf`에 설정한 값은 병렬 빌드를 지원하는 대부분의 패키지에 적용됩니다.
